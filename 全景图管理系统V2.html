<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÖ®ÊôØÂõæÁÆ°ÁêÜÁ≥ªÁªü V2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        
        .floor-plan-section {
            flex: 2;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .preview-section {
            flex: 1;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-title {
            font-size: 1.2rem;
            color: #fdbb2d;
            font-weight: bold;
        }
        
        .section-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .control-btn.active {
            background: #fdbb2d;
            color: #1a2a6c;
            font-weight: bold;
        }
        
        .floor-content {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }
        
        .floor-canvas-container {
            flex: 3;
            position: relative;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #floor-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            display: block;
        }
        
        .floor-controls-panel {
            flex: 1;
            max-width: 300px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }
        
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
            color: #fdbb2d;
        }
        
        .upload-text {
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .browse-btn {
            background: #fdbb2d;
            color: #1a2a6c;
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }
        
        .browse-btn:hover {
            background: #ffcc44;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .control-group {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
        }
        
        .control-group-title {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: #fdbb2d;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 5px;
        }
        
        .floor-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .preview-container {
            flex: 1;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 15px;
            align-items: center;
        }
        
        .preview-item {
            min-width: 200px;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            flex-shrink: 0;
        }
        
        .preview-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .preview-item.active {
            border-color: #fdbb2d;
            transform: scale(1.05);
        }
        
        .preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .preview-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .preview-name {
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .preview-points {
            font-size: 0.7rem;
            opacity: 0.8;
        }
        
        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.1rem;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 20px;
            border-radius: 8px;
        }
        
        .mode-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 5px;
            border-left: 4px solid #fdbb2d;
            font-weight: bold;
            z-index: 1000;
            display: none;
        }
        
        .panorama-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: row;
        }
        
        .panorama-list-container {
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panorama-list-header {
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panorama-list-title {
            color: #fdbb2d;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .panorama-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .panorama-list-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .panorama-list-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .panorama-list-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fdbb2d;
        }
        
        .panorama-list-name {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .panorama-list-date {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .panorama-viewer-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .panorama-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.7);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .panorama-title {
            font-size: 1.2rem;
            color: #fdbb2d;
        }
        
        .panorama-close {
            background: #ff4444;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .panorama-viewer {
            flex: 1;
            position: relative;
        }
        
        #panorama-canvas {
            width: 100%;
            height: 100%;
        }
        
        .panorama-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .panorama-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #fdbb2d;
            border-radius: 50%;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #fdbb2d;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .save-load-buttons {
            display: flex;
            gap: 8px;
        }
        
        .data-operation-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            flex: 1;
        }
        
        .data-operation-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .data-operation-btn.save {
            background: #4CAF50;
        }
        
        .data-operation-btn.load {
            background: #2196F3;
        }
        
        .data-operation-btn.export {
            background: #9C27B0;
        }
        
        .data-operation-btn.import {
            background: #FF9800;
        }
        
        /* ÁÇπ‰ΩçÂÖ≥ËÅîÊ∏ÖÂçïÂØπËØùÊ°ÜÊ†∑Âºè */
        .point-association-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .point-association-content {
            background: #2a2a2a;
            width: 90%;
            max-width: 800px;
            height: 80%;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .point-association-header {
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .point-association-title {
            color: #fdbb2d;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .point-association-close {
            background: #ff4444;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .point-association-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .point-list-container {
            width: 300px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .point-list-header {
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .point-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .point-list-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .point-list-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .point-list-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fdbb2d;
        }
        
        .point-list-name {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .point-list-count {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .panorama-list-container-modal {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panorama-list-header-modal {
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .panorama-list-modal {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .panorama-list-item-modal {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panorama-list-info {
            flex: 1;
        }
        
        .panorama-list-name-modal {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .panorama-list-date-modal {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .panorama-delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 10px;
            transition: all 0.3s;
        }
        
        .panorama-delete-btn:hover {
            background: #ff6666;
        }
        
        .empty-message {
            text-align: center;
            padding: 40px;
            opacity: 0.7;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ÂÖ®ÊôØÂõæÁÆ°ÁêÜÁ≥ªÁªü V2</h1>
        </header>
        
        <div class="main-content">
            <section class="floor-plan-section">
                <div class="section-header">
                    <div class="section-title">Âπ≥Èù¢ÂõæÊ†áÊ≥® - ÂΩìÂâçÊ•ºÂ±Ç: <span id="current-floor-display">1</span></div>
                    <div class="section-controls">
                        <button class="control-btn" id="add-point-btn">Ê∑ªÂä†ÁÇπ‰Ωç</button>
                        <button class="control-btn" id="associate-btn">ÂÖ≥ËÅîÂÖ®ÊôØÂõæ</button>
                        <button class="control-btn" id="clear-points-btn">Ê∏ÖÈô§ÁÇπ‰Ωç</button>
                        <button class="control-btn" id="modify-point-btn">‰øÆÊîπÁÇπ‰ΩçÁºñÂè∑</button>
                        <button class="control-btn" id="zoom-in-btn">ÊîæÂ§ß</button>
                        <button class="control-btn" id="zoom-out-btn">Áº©Â∞è</button>
                        <button class="control-btn" id="reset-view-btn">ÈáçÁΩÆËßÜÂõæ</button>
                        <button class="control-btn" id="point-association-list-btn">ÁÇπ‰ΩçÂÖ≥ËÅîÊ∏ÖÂçï</button>
                    </div>
                </div>
                
                <div class="floor-content">
                    <div class="floor-canvas-container">
                        <canvas id="floor-canvas"></canvas>
                        <div class="loading" id="floor-loading" style="display: none;">Âä†ËΩΩÂπ≥Èù¢Âõæ...</div>
                    </div>
                    
                    <div class="floor-controls-panel">
                        <div class="upload-area" id="upload-floor-area">
                            <div class="upload-icon">üè¢</div>
                            <h4>‰∏ä‰º†Âπ≥Èù¢Âõæ</h4>
                            <p class="upload-text">ÊîØÊåÅJPEG„ÄÅPNGÊ†ºÂºè</p>
                            <button class="browse-btn" id="browse-floor-btn">ÈÄâÊã©Âπ≥Èù¢Âõæ</button>
                        </div>
                        
                        <div class="control-group">
                            <div class="control-group-title">Ê•ºÂ±ÇÁÆ°ÁêÜ</div>
                            <div class="floor-buttons" id="floor-buttons-container">
                                <button class="control-btn floor-btn active" data-floor="1">1</button>
                                <button class="control-btn floor-btn" data-floor="2">2</button>
                                <button class="control-btn floor-btn" data-floor="3">3</button>
                                <button class="control-btn" id="add-floor-btn">Ê∑ªÂä†Ê•ºÂ±Ç</button>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <div class="control-group-title">Êï∞ÊçÆÊìç‰Ωú</div>
                            <div class="save-load-buttons">
                                <button class="data-operation-btn save" id="save-data-btn">‰øùÂ≠òÊï∞ÊçÆ</button>
                                <button class="data-operation-btn load" id="load-data-btn">Âä†ËΩΩÊï∞ÊçÆ</button>
                            </div>
                            <div class="save-load-buttons" style="margin-top: 8px;">
                                <button class="data-operation-btn export" id="export-data-btn">ÂØºÂá∫Êñá‰ª∂</button>
                                <button class="data-operation-btn import" id="import-data-btn">ÂØºÂÖ•Êñá‰ª∂</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="preview-section">
                <div class="section-header">
                    <div class="section-title" id="preview-section-title">Ê•ºÂ±Ç <span id="preview-floor-display">1</span> ÂÖ®ÊôØÂõæÈ¢ÑËßà (<span id="panorama-count">0</span>Âº†)</div>
                    <div class="section-controls">
                        <button class="control-btn" id="upload-panorama-btn">‰∏ä‰º†ÂÖ®ÊôØÂõæ</button>
                        <button class="control-btn" id="clear-all-data-btn">Ê∏ÖÈô§ÂÖ®ÈÉ®Êï∞ÊçÆ</button>
                    </div>
                </div>
                
                <div class="preview-container" id="preview-container">
                    <div style="width: 100%; text-align: center; padding: 40px; opacity: 0.7;">
                        ÂΩìÂâçÊ•ºÂ±ÇÊöÇÊó†ÂÖ≥ËÅîÂÖ®ÊôØÂõæÁöÑÁÇπ‰Ωç
                    </div>
                </div>
            </section>
        </div>
    </div>

    <div class="mode-indicator" id="mode-indicator"></div>

    <div class="panorama-fullscreen" id="panorama-fullscreen" style="display: none;">
        <div class="panorama-list-container">
            <div class="panorama-list-header">
                <div class="panorama-list-title">ÂÖ≥ËÅîÂÖ®ÊôØÂõæ</div>
            </div>
            <div class="panorama-list" id="panorama-list">
            </div>
        </div>
        <div class="panorama-viewer-container">
            <div class="panorama-header">
                <div class="panorama-title" id="panorama-title">ÂÖ®ÊôØÂõæÊü•ÁúãÂô®</div>
                <button class="panorama-close" id="panorama-close">√ó</button>
            </div>
            <div class="panorama-viewer">
                <div id="panorama-canvas"></div>
            </div>
            <div class="panorama-controls">
                <button class="panorama-btn" id="prev-panorama-btn">‚óÄ</button>
                <button class="panorama-btn" id="reset-panorama-view-btn">‚Ü∫</button>
                <button class="panorama-btn" id="next-panorama-btn">‚ñ∂</button>
            </div>
        </div>
    </div>

    <!-- ÁÇπ‰ΩçÂÖ≥ËÅîÊ∏ÖÂçïÂØπËØùÊ°Ü -->
    <div class="point-association-modal" id="point-association-modal">
        <div class="point-association-content">
            <div class="point-association-header">
                <div class="point-association-title">ÁÇπ‰ΩçÂÖ≥ËÅîÊ∏ÖÂçï - ÂΩìÂâçÊ•ºÂ±Ç: <span id="modal-floor-display">1</span></div>
                <button class="point-association-close" id="point-association-close">√ó</button>
            </div>
            <div class="point-association-body">
                <div class="point-list-container">
                    <div class="point-list-header">ÂΩìÂâçÊ•ºÂ±ÇÁÇπ‰ΩçÂàóË°®</div>
                    <div class="point-list" id="point-list">
                        <!-- ÁÇπ‰ΩçÂàóË°®Â∞ÜÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
                <div class="panorama-list-container-modal">
                    <div class="panorama-list-header-modal">ÁÇπ‰Ωç <span id="selected-point-name">Êú™ÈÄâÊã©</span> ÁöÑÂÖ≥ËÅîÂÖ®ÊôØÂõæ</div>
                    <div class="panorama-list-modal" id="panorama-list-modal">
                        <div class="empty-message">ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™ÁÇπ‰ΩçÊü•ÁúãÂÖ∂ÂÖ≥ËÅîÁöÑÂÖ®ÊôØÂõæ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="file-input-floor" accept="image/jpeg,image/png" style="display: none;">
    <input type="file" id="file-input-panorama" accept="image/jpeg,image/png" multiple style="display: none;">
    <input type="file" id="file-import-data" accept=".json" style="display: none;">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    
    <script>
        class PanoramaManagementSystem {
            constructor() {
                console.log('ÂàùÂßãÂåñÂÖ®ÊôØÂõæÁÆ°ÁêÜÁ≥ªÁªü V2...');
                this.initVariables();
                this.init();
                this.setupEventListeners();
                this.loadAllData();
            }
            
            initVariables() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.controls = null;
                this.sphere = null;
                
                this.floorImages = {};
                this.floorCanvas = document.getElementById('floor-canvas');
                this.floorCtx = this.floorCanvas.getContext('2d');
                this.floorPoints = [];
                this.currentFloor = '1';
                this.mode = 'normal'; // normal, add, delete, modify, associate
                this.selectedPoint = null;
                this.pointPanoramaMap = new Map();
                this.panoramas = [];
                this.currentPanoramaIndex = 0;
                this.currentPointId = null;
                
                this.scale = 1.0;
                this.offsetX = 0;
                this.offsetY = 0;
                this.isDragging = false;
                this.lastX = 0;
                this.lastY = 0;
                
                // Âõ∫ÂÆöÁÇπ‰ΩçÂ§ßÂ∞è
                this.pointRadius = 32; // Âõ∫ÂÆöÂÄº
                this.pointFontSize = 30; // Âõ∫ÂÆöÂÄºÔºåÂéü12*2.5=30
                
                this.STORAGE_KEYS = {
                    FLOOR_PLANS: 'panoramaSystem_floorPlans',
                    POINTS: 'panoramaSystem_points',
                    PANORAMAS: 'panoramaSystem_panoramas',
                    ASSOCIATIONS: 'panoramaSystem_associations'
                };
            }
            
            init() {
                this.adjustCanvasSize();
                this.updateCurrentFloorDisplay();
                this.createExampleFloorPlans();
            }
            
            createExampleFloorPlans() {
                const floors = ['1', '2', '3'];
                
                floors.forEach(floor => {
                    if (!localStorage.getItem(this.STORAGE_KEYS.FLOOR_PLANS)) {
                        this.createDefaultFloorPlan(floor);
                    }
                });
            }
            
            createDefaultFloorPlan(floor) {
                const canvas = document.createElement('canvas');
                canvas.width = 800;
                canvas.height = 600;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.strokeStyle = '#d0d0d0';
                ctx.lineWidth = 1;
                const gridSize = 50;
                for (let x = 0; x <= canvas.width; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                for (let y = 0; y <= canvas.height; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
                
                if (floor === '1') {
                    ctx.fillStyle = '#e0e0ff';
                    ctx.fillRect(100, 100, 300, 200);
                    ctx.fillRect(450, 100, 250, 400);
                } else if (floor === '2') {
                    ctx.fillStyle = '#e0ffe0';
                    ctx.fillRect(100, 100, 200, 150);
                    ctx.fillRect(350, 100, 200, 150);
                } else if (floor === '3') {
                    ctx.fillStyle = '#ffe0e0';
                    ctx.fillRect(150, 100, 500, 400);
                }
                
                this.floorImages[floor] = new Image();
                this.floorImages[floor].src = canvas.toDataURL();
                this.floorImages[floor].onload = () => {
                    this.autoAdjustImage();
                    this.renderFloorPlan();
                };
            }
            
            autoAdjustImage() {
                if (!this.floorImages[this.currentFloor]) return;
                
                const img = this.floorImages[this.currentFloor];
                const canvasWidth = this.floorCanvas.width;
                const canvasHeight = this.floorCanvas.height;
                const imgWidth = img.width;
                const imgHeight = img.height;
                
                const widthRatio = canvasWidth / imgWidth;
                const heightRatio = canvasHeight / imgHeight;
                
                this.scale = Math.min(widthRatio, heightRatio) * 0.9;
                this.offsetX = (canvasWidth - imgWidth * this.scale) / 2;
                this.offsetY = (canvasHeight - imgHeight * this.scale) / 2;
            }
            
            setupEventListeners() {
                document.getElementById('browse-floor-btn').addEventListener('click', () => {
                    document.getElementById('file-input-floor').click();
                });
                
                document.getElementById('file-input-floor').addEventListener('change', (e) => {
                    if (e.target.files && e.target.files.length > 0) {
                        this.loadFloorPlan(e.target.files[0]);
                    }
                });
                
                document.getElementById('upload-panorama-btn').addEventListener('click', () => {
                    document.getElementById('file-input-panorama').click();
                });
                
                document.getElementById('file-input-panorama').addEventListener('change', (e) => {
                    if (e.target.files && e.target.files.length > 0) {
                        for (let i = 0; i < e.target.files.length; i++) {
                            this.loadPanorama(e.target.files[i]);
                        }
                    }
                });
                
                document.getElementById('add-point-btn').addEventListener('click', () => {
                    this.setMode('add');
                });
                
                document.getElementById('clear-points-btn').addEventListener('click', () => {
                    this.setMode('delete');
                });
                
                document.getElementById('modify-point-btn').addEventListener('click', () => {
                    this.setMode('modify');
                });
                
                document.getElementById('associate-btn').addEventListener('click', () => {
                    this.setMode('associate');
                });
                
                // ‰øÆÊîπÔºöÂ∞ÜÊ∏ÖÈô§ÂÖ≥ËÅîÊåâÈíÆÊîπ‰∏∫ÁÇπ‰ΩçÂÖ≥ËÅîÊ∏ÖÂçï
                document.getElementById('point-association-list-btn').addEventListener('click', () => {
                    this.showPointAssociationList();
                });
                
                document.getElementById('zoom-in-btn').addEventListener('click', () => {
                    this.scale *= 1.2;
                    this.renderFloorPlan();
                });
                
                document.getElementById('zoom-out-btn').addEventListener('click', () => {
                    this.scale /= 1.2;
                    this.renderFloorPlan();
                });
                
                document.getElementById('reset-view-btn').addEventListener('click', () => {
                    this.autoAdjustImage();
                    this.renderFloorPlan();
                });
                
                document.querySelectorAll('.floor-btn').forEach(btn => {
                    if (btn.id !== 'add-floor-btn') {
                        btn.addEventListener('click', (e) => {
                            document.querySelectorAll('.floor-btn').forEach(b => {
                                if (b.id !== 'add-floor-btn') b.classList.remove('active');
                            });
                            e.target.classList.add('active');
                            this.currentFloor = e.target.dataset.floor;
                            this.updateCurrentFloorDisplay();
                            this.autoAdjustImage();
                            this.renderFloorPlan();
                            this.updatePreviewItems();
                        });
                    }
                });
                
                document.getElementById('add-floor-btn').addEventListener('click', () => {
                    const floorButtons = document.querySelectorAll('.floor-btn');
                    const floorNumber = floorButtons.length;
                    const newFloor = (floorNumber + 1).toString();
                    
                    const newFloorBtn = document.createElement('button');
                    newFloorBtn.className = 'control-btn floor-btn';
                    newFloorBtn.dataset.floor = newFloor;
                    newFloorBtn.textContent = newFloor;
                    newFloorBtn.addEventListener('click', (e) => {
                        document.querySelectorAll('.floor-btn').forEach(b => {
                            if (b.id !== 'add-floor-btn') b.classList.remove('active');
                        });
                        e.target.classList.add('active');
                        this.currentFloor = e.target.dataset.floor;
                        this.updateCurrentFloorDisplay();
                        this.autoAdjustImage();
                        this.renderFloorPlan();
                        this.updatePreviewItems();
                    });
                    
                    document.getElementById('floor-buttons-container').appendChild(newFloorBtn);
                    
                    this.createDefaultFloorPlan(newFloor);
                });
                
                document.getElementById('save-data-btn').addEventListener('click', () => {
                    this.saveAllData();
                    alert('Êï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞ÊµèËßàÂô®Êú¨Âú∞Â≠òÂÇ®');
                });
                
                document.getElementById('load-data-btn').addEventListener('click', () => {
                    this.loadAllData();
                    alert('Â∑≤‰ªéÊµèËßàÂô®Êú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÊï∞ÊçÆ');
                });
                
                document.getElementById('export-data-btn').addEventListener('click', () => {
                    this.exportData();
                });
                
                document.getElementById('import-data-btn').addEventListener('click', () => {
                    document.getElementById('file-import-data').click();
                });
                
                document.getElementById('file-import-data').addEventListener('change', (e) => {
                    if (e.target.files && e.target.files.length > 0) {
                        this.importData(e.target.files[0]);
                    }
                });
                
                document.getElementById('clear-all-data-btn').addEventListener('click', () => {
                    if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                        this.clearAllData();
                    }
                });
                
                // ÁÇπ‰ΩçÂÖ≥ËÅîÊ∏ÖÂçïÂØπËØùÊ°ÜÂÖ≥Èó≠ÊåâÈíÆ
                document.getElementById('point-association-close').addEventListener('click', () => {
                    document.getElementById('point-association-modal').style.display = 'none';
                });
                
                this.setupCanvasEventListeners();
                
                document.getElementById('panorama-close').addEventListener('click', () => {
                    this.hideFullscreenPanorama();
                });
                
                document.getElementById('prev-panorama-btn').addEventListener('click', () => {
                    this.showPreviousPanorama();
                });
                
                document.getElementById('next-panorama-btn').addEventListener('click', () => {
                    this.showNextPanorama();
                });
                
                document.getElementById('reset-panorama-view-btn').addEventListener('click', () => {
                    if (this.controls) {
                        this.controls.reset();
                    }
                });
                
                window.addEventListener('resize', () => {
                    this.adjustCanvasSize();
                });
            }
            
            setMode(mode) {
                this.mode = mode;
                this.updateCanvasCursor();
                this.updateModeIndicator();
                
                document.getElementById('add-point-btn').classList.toggle('active', mode === 'add');
                document.getElementById('clear-points-btn').classList.toggle('active', mode === 'delete');
                document.getElementById('modify-point-btn').classList.toggle('active', mode === 'modify');
                document.getElementById('associate-btn').classList.toggle('active', mode === 'associate');
                document.getElementById('point-association-list-btn').classList.toggle('active', false);
                
                if (mode === 'associate') {
                    this.selectedPoint = null;
                }
            }
            
            updateModeIndicator() {
                const indicator = document.getElementById('mode-indicator');
                const messages = {
                    'normal': 'Ê≠£Â∏∏Ê®°Âºè',
                    'add': 'Ê∑ªÂä†ÁÇπ‰ΩçÊ®°Âºè - ÁÇπÂáªÂπ≥Èù¢ÂõæÊ∑ªÂä†ÁÇπ‰Ωç',
                    'delete': 'Âà†Èô§ÁÇπ‰ΩçÊ®°Âºè - ÁÇπÂáªÁÇπ‰ΩçËøõË°åÂà†Èô§',
                    'modify': '‰øÆÊîπÁÇπ‰ΩçÁºñÂè∑ - ÁÇπÂáªÁÇπ‰Ωç‰øÆÊîπÁºñÂè∑',
                    'associate': 'ÂÖ≥ËÅîÂÖ®ÊôØÂõæÊ®°Âºè - ÁÇπÂáªÁÇπ‰ΩçÂÖ≥ËÅîÂÖ®ÊôØÂõæ'
                };
                
                if (messages[this.mode]) {
                    indicator.textContent = messages[this.mode];
                    indicator.style.display = 'block';
                    
                    setTimeout(() => {
                        if (indicator.textContent === messages[this.mode]) {
                            indicator.style.display = 'none';
                        }
                    }, 3000);
                } else {
                    indicator.style.display = 'none';
                }
            }
            
            setupCanvasEventListeners() {
                this.floorCanvas.addEventListener('mousedown', (e) => {
                    this.handleCanvasMouseDown(e);
                });
                
                this.floorCanvas.addEventListener('mousemove', (e) => {
                    this.handleCanvasMouseMove(e);
                });
                
                this.floorCanvas.addEventListener('mouseup', () => {
                    this.handleCanvasMouseUp();
                });
                
                this.floorCanvas.addEventListener('click', (e) => {
                    this.handleCanvasClick(e);
                });
            }
            
            handleCanvasMouseDown(e) {
                if (!this.floorImages[this.currentFloor]) return;
                
                const rect = this.floorCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const imgX = (x - this.offsetX) / this.scale;
                const imgY = (y - this.offsetY) / this.scale;
                
                const clickedPoint = this.getPointAtPosition(imgX, imgY);
                
                if (!clickedPoint) {
                    this.isDragging = true;
                    this.lastX = e.clientX;
                    this.lastY = e.clientY;
                    this.floorCanvas.style.cursor = 'grabbing';
                }
            }
            
            handleCanvasMouseMove(e) {
                if (!this.isDragging) return;
                
                const rect = this.floorCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const dx = x - this.lastX;
                const dy = y - this.lastY;
                
                this.offsetX += dx;
                this.offsetY += dy;
                
                this.lastX = x;
                this.lastY = y;
                
                this.renderFloorPlan();
            }
            
            handleCanvasMouseUp() {
                this.isDragging = false;
                this.updateCanvasCursor();
            }
            
            handleCanvasClick(e) {
                if (!this.floorImages[this.currentFloor] || this.isDragging) return;
                
                const rect = this.floorCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const imgX = (x - this.offsetX) / this.scale;
                const imgY = (y - this.offsetY) / this.scale;
                
                const clickedPoint = this.getPointAtPosition(imgX, imgY);
                
                switch (this.mode) {
                    case 'add':
                        this.createNewPoint(imgX, imgY);
                        break;
                    case 'delete':
                        if (clickedPoint) {
                            this.deleteSinglePoint(clickedPoint.id);
                        }
                        break;
                    case 'modify':
                        if (clickedPoint) {
                            this.showModifyDialog(clickedPoint);
                        }
                        break;
                    case 'associate':
                        if (clickedPoint) {
                            this.associatePanoramaToPoint(clickedPoint.id);
                        }
                        break;
                    case 'normal':
                        if (clickedPoint) {
                            this.selectedPoint = clickedPoint.id;
                            this.showPanoramaByPointId(clickedPoint.id);
                        } else {
                            this.selectedPoint = null;
                        }
                        break;
                }
            }
            
            updateCanvasCursor() {
                switch (this.mode) {
                    case 'add':
                        this.floorCanvas.style.cursor = 'crosshair';
                        break;
                    case 'delete':
                        this.floorCanvas.style.cursor = 'not-allowed';
                        break;
                    case 'modify':
                    case 'associate':
                        this.floorCanvas.style.cursor = 'pointer';
                        break;
                    default:
                        this.floorCanvas.style.cursor = 'grab';
                }
            }
            
            adjustCanvasSize() {
                const container = document.querySelector('.floor-canvas-container');
                if (container) {
                    this.floorCanvas.width = container.clientWidth;
                    this.floorCanvas.height = container.clientHeight;
                    this.autoAdjustImage();
                    this.renderFloorPlan();
                }
            }
            
            renderFloorPlan() {
                if (!this.floorImages[this.currentFloor]) return;
                
                this.floorCtx.clearRect(0, 0, this.floorCanvas.width, this.floorCanvas.height);
                
                this.floorCtx.save();
                this.floorCtx.translate(this.offsetX, this.offsetY);
                this.floorCtx.scale(this.scale, this.scale);
                
                this.floorCtx.drawImage(this.floorImages[this.currentFloor], 0, 0);
                
                const currentFloorPoints = this.floorPoints.filter(point => point.floor === this.currentFloor);
                currentFloorPoints.forEach(point => {
                    this.floorCtx.fillStyle = point.id === this.selectedPoint ? '#ff4444' : 
                                        this.pointPanoramaMap.has(point.id) ? '#4CAF50' : '#fdbb2d';
                    this.floorCtx.beginPath();
                    this.floorCtx.arc(point.x, point.y, this.pointRadius, 0, Math.PI * 2);
                    this.floorCtx.fill();
                    
                    this.floorCtx.strokeStyle = 'white';
                    this.floorCtx.lineWidth = 2;
                    this.floorCtx.stroke();
                    
                    // Âõ∫ÂÆöÂ≠ó‰ΩìÂ§ßÂ∞è
                    this.floorCtx.fillStyle = '#1a2a6c';
                    this.floorCtx.font = `bold ${this.pointFontSize}px Arial`;
                    this.floorCtx.textAlign = 'center';
                    this.floorCtx.textBaseline = 'middle';
                    this.floorCtx.fillText(point.id, point.x, point.y);
                });
                
                this.floorCtx.restore();
            }
            
            getPointAtPosition(x, y) {
                const currentFloorPoints = this.floorPoints.filter(point => point.floor === this.currentFloor);
                for (const point of currentFloorPoints) {
                    const distance = Math.sqrt(Math.pow(x - point.x, 2) + Math.pow(y - point.y, 2));
                    
                    // ‰ΩøÁî®Âõ∫ÂÆöÁöÑÁÇπ‰ΩçÂçäÂæÑ
                    if (distance <= (this.pointRadius + 5) / this.scale) {
                        return point;
                    }
                }
                return null;
            }
            
            createNewPoint(x, y) {
                const currentFloorPoints = this.floorPoints.filter(point => point.floor === this.currentFloor);
                const pointNumber = currentFloorPoints.length + 1;
                const pointId = `${this.currentFloor}F-${pointNumber}`;
                
                const newPoint = {
                    id: pointId,
                    x: x,
                    y: y,
                    floor: this.currentFloor
                };
                
                this.floorPoints.push(newPoint);
                this.renderFloorPlan();
                this.updatePreviewItems();
                this.saveAllData();
            }
            
            deleteSinglePoint(pointId) {
                if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÁÇπ‰Ωç ${pointId} ÂêóÔºü`)) {
                    this.floorPoints = this.floorPoints.filter(point => point.id !== pointId);
                    this.pointPanoramaMap.delete(pointId);
                    
                    if (this.selectedPoint === pointId) {
                        this.selectedPoint = null;
                    }
                    
                    this.renderFloorPlan();
                    this.updatePreviewItems();
                    this.saveAllData();
                }
            }
            
            showModifyDialog(point) {
                const dialogHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
                        <div style="background: #2a2a2a; padding: 20px; border-radius: 10px; width: 350px;">
                            <h3 style="color: #fdbb2d; margin-bottom: 10px;">‰øÆÊîπÁÇπ‰ΩçÁºñÂè∑</h3>
                            <p style="margin-bottom: 5px;">ÂΩìÂâçÁÇπ‰Ωç: ${point.id}</p>
                            <p style="margin-bottom: 5px; font-size: 0.9rem; opacity: 0.8;">Êñ∞ÁºñÂè∑Ê†ºÂºè: Ê•ºÂ±ÇF-Â∫èÂè∑ (‰æãÂ¶Ç: 1F-1)</p>
                            <input type="text" id="new-point-id-input" style="width: 100%; padding: 8px; margin: 10px 0; border-radius: 5px; background: rgba(0,0,0,0.5); color: white; border: 1px solid rgba(255,255,255,0.3);" placeholder="ËæìÂÖ•Êñ∞ÁÇπ‰ΩçÁºñÂè∑">
                            <div id="modify-error" style="color: #ff4444; font-size: 0.8rem; margin: 5px 0; display: none;"></div>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button id="confirm-modify" style="flex: 1; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">Á°ÆÂÆö</button>
                                <button id="cancel-modify" style="flex: 1; padding: 8px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">ÂèñÊ∂à</button>
                            </div>
                        </div>
                    </div>
                `;
                
                const dialog = document.createElement('div');
                dialog.innerHTML = dialogHTML;
                document.body.appendChild(dialog);
                
                document.getElementById('confirm-modify').addEventListener('click', () => {
                    const newPointId = document.getElementById('new-point-id-input').value.trim();
                    const errorElement = document.getElementById('modify-error');
                    
                    if (!newPointId) {
                        errorElement.textContent = 'ËØ∑ËæìÂÖ•Êñ∞ÁÇπ‰ΩçÁºñÂè∑';
                        errorElement.style.display = 'block';
                        return;
                    }
                    
                    if (newPointId === point.id) {
                        errorElement.textContent = 'Êñ∞ÁºñÂè∑‰∏éÂΩìÂâçÁºñÂè∑Áõ∏Âêå';
                        errorElement.style.display = 'block';
                        return;
                    }
                    
                    const existingPoint = this.floorPoints.find(p => p.id === newPointId);
                    if (existingPoint) {
                        errorElement.textContent = 'ËØ•ÁºñÂè∑Â∑≤Â≠òÂú®ÔºåËØ∑‰ΩøÁî®ÂÖ∂‰ªñÁºñÂè∑';
                        errorElement.style.display = 'block';
                        return;
                    }
                    
                    const idRegex = /^\d+F-\d+$/;
                    if (!idRegex.test(newPointId)) {
                        errorElement.textContent = 'ÁºñÂè∑Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∫î‰∏∫: Ê•ºÂ±ÇF-Â∫èÂè∑ (‰æãÂ¶Ç: 1F-1)';
                        errorElement.style.display = 'block';
                        return;
                    }
                    
                    const newFloor = newPointId.split('F-')[0];
                    if (newFloor !== this.currentFloor) {
                        errorElement.textContent = 'Êñ∞ÁºñÂè∑ÁöÑÊ•ºÂ±Ç‰∏éÂΩìÂâçÊ•ºÂ±Ç‰∏ç‰∏ÄËá¥';
                        errorElement.style.display = 'block';
                        return;
                    }
                    
                    const oldPointId = point.id;
                    point.id = newPointId;
                    
                    if (this.pointPanoramaMap.has(oldPointId)) {
                        const panoramaIndices = this.pointPanoramaMap.get(oldPointId);
                        this.pointPanoramaMap.delete(oldPointId);
                        this.pointPanoramaMap.set(newPointId, panoramaIndices);
                    }
                    
                    this.selectedPoint = newPointId;
                    this.renderFloorPlan();
                    this.updatePreviewItems();
                    this.saveAllData();
                    
                    document.body.removeChild(dialog);
                    alert(`ÁÇπ‰ΩçÁºñÂè∑Â∑≤‰ªé ${oldPointId} ÂèòÊõ¥‰∏∫ ${newPointId}`);
                });
                
                document.getElementById('cancel-modify').addEventListener('click', () => {
                    document.body.removeChild(dialog);
                });
            }
            
            associatePanoramaToPoint(pointId) {
                const fileInput = document.getElementById('file-input-panorama');
                
                const onFileSelected = (e) => {
                    if (e.target.files && e.target.files.length > 0) {
                        let panoramaCount = 0;
                        
                        for (let i = 0; i < e.target.files.length; i++) {
                            this.loadPanorama(e.target.files[i], pointId);
                            panoramaCount++;
                        }
                        
                        alert(`Â∑≤ÊàêÂäüÂ∞Ü ${panoramaCount} ‰∏™ÂÖ®ÊôØÂõæÂÖ≥ËÅîÂà∞ÁÇπ‰Ωç ${pointId}`);
                    }
                    
                    fileInput.removeEventListener('change', onFileSelected);
                    fileInput.value = '';
                    
                    this.setMode('normal');
                };
                
                fileInput.addEventListener('change', onFileSelected);
                fileInput.click();
            }
            
            updateCurrentFloorDisplay() {
                document.getElementById('current-floor-display').textContent = this.currentFloor;
                document.getElementById('preview-floor-display').textContent = this.currentFloor;
            }
            
            loadFloorPlan(imageFile) {
                if (!imageFile.type.match('image.*')) {
                    alert('ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑÂõæÁâáÊñá‰ª∂ÔºàJPEG„ÄÅPNGÔºâ');
                    return;
                }
                
                const reader = new FileReader();
                const loadingIndicator = document.getElementById('floor-loading');
                
                loadingIndicator.style.display = 'block';
                
                reader.onload = (e) => {
                    this.floorImages[this.currentFloor] = new Image();
                    this.floorImages[this.currentFloor].src = e.target.result;
                    
                    this.floorImages[this.currentFloor].onload = () => {
                        this.autoAdjustImage();
                        this.renderFloorPlan();
                        loadingIndicator.style.display = 'none';
                        this.saveAllData();
                    };
                    
                    this.floorImages[this.currentFloor].onerror = () => {
                        alert('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•');
                        loadingIndicator.style.display = 'none';
                    };
                };
                
                reader.onerror = () => {
                    alert('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•');
                    loadingIndicator.style.display = 'none';
                };
                
                reader.readAsDataURL(imageFile);
            }
            
            loadPanorama(imageFile, pointId = null) {
                if (!imageFile.type.match('image.*')) {
                    alert('ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑÂõæÁâáÊñá‰ª∂ÔºàJPEG„ÄÅPNGÔºâ');
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const image = new Image();
                    image.src = e.target.result;
                    
                    image.onload = () => {
                        const date = this.formatDate(new Date(imageFile.lastModified));
                        const panorama = {
                            name: imageFile.name,
                            url: image.src,
                            date: date
                        };
                        
                        this.panoramas.push(panorama);
                        const panoramaIndex = this.panoramas.length - 1;
                        
                        if (pointId) {
                            if (!this.pointPanoramaMap.has(pointId)) {
                                this.pointPanoramaMap.set(pointId, []);
                            }
                            
                            const panoramaIndices = this.pointPanoramaMap.get(pointId);
                            if (!panoramaIndices.includes(panoramaIndex)) {
                                panoramaIndices.push(panoramaIndex);
                                this.pointPanoramaMap.set(pointId, panoramaIndices);
                            }
                        }
                        
                        this.sortPanoramasByDate();
                        this.updatePreviewItems();
                        this.renderFloorPlan();
                        this.saveAllData();
                    };
                    
                    image.onerror = () => {
                        alert('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•ÔºåÊñá‰ª∂ÂèØËÉΩÂ∑≤ÊçüÂùè');
                    };
                };
                
                reader.onerror = () => {
                    alert('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•');
                };
                
                reader.readAsDataURL(imageFile);
            }
            
            sortPanoramasByDate() {
                this.panoramas.sort((a, b) => {
                    return new Date(b.date) - new Date(a.date);
                });
            }
            
            formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            updatePreviewItems() {
                const previewContainer = document.getElementById('preview-container');
                previewContainer.innerHTML = '';
                
                // Ëé∑ÂèñÂΩìÂâçÊ•ºÂ±ÇÁöÑÊâÄÊúâÁÇπ‰Ωç
                const currentFloorPoints = this.floorPoints.filter(point => point.floor === this.currentFloor);
                
                // Áî®‰∫éÂ≠òÂÇ®ÊØè‰∏™ÁÇπ‰ΩçÊúÄÊñ∞ÁöÑÂÖ®ÊôØÂõæ
                const pointLatestPanoramas = [];
                
                // ÈÅçÂéÜÂΩìÂâçÊ•ºÂ±ÇÁöÑÊØè‰∏™ÁÇπ‰Ωç
                for (const point of currentFloorPoints) {
                    if (this.pointPanoramaMap.has(point.id)) {
                        const panoramaIndices = this.pointPanoramaMap.get(point.id);
                        
                        if (panoramaIndices.length > 0) {
                            // Ëé∑ÂèñÊØè‰∏™ÁÇπ‰ΩçÂÖ≥ËÅîÁöÑÊâÄÊúâÂÖ®ÊôØÂõæÔºåÂπ∂ÊåâÊó•ÊúüÊéíÂ∫èÔºà‰ªéÊñ∞Âà∞ÊóßÔºâ
                            const sortedPanoramas = panoramaIndices
                                .map(index => ({ ...this.panoramas[index], originalIndex: index }))
                                .sort((a, b) => new Date(b.date) - new Date(a.date));
                            
                            // Âè™ÂèñÊúÄÊñ∞ÁöÑ‰∏ÄÂº†
                            const latestPanorama = sortedPanoramas[0];
                            if (latestPanorama) {
                                pointLatestPanoramas.push({
                                    panorama: latestPanorama,
                                    pointId: point.id
                                });
                            }
                        }
                    }
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÂÖ≥ËÅîÁöÑÂÖ®ÊôØÂõæ
                if (pointLatestPanoramas.length === 0) {
                    previewContainer.innerHTML = '<div style="width: 100%; text-align: center; padding: 40px; opacity: 0.7;">ÂΩìÂâçÊ•ºÂ±ÇÊöÇÊó†ÂÖ≥ËÅîÂÖ®ÊôØÂõæÁöÑÁÇπ‰Ωç</div>';
                    document.getElementById('panorama-count').textContent = '0';
                    return;
                }
                
                // ÊåâÂÖ®ÊôØÂõæÊó•Êúü‰ªéÊñ∞Âà∞ÊóßÊéíÂ∫è
                pointLatestPanoramas.sort((a, b) => new Date(b.panorama.date) - new Date(a.panorama.date));
                
                // ÊòæÁ§∫ÊØè‰∏™ÁÇπ‰ΩçÁöÑÊúÄÊñ∞ÂÖ®ÊôØÂõæ
                pointLatestPanoramas.forEach((item) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = `preview-item ${item.panorama.originalIndex === this.currentPanoramaIndex ? 'active' : ''}`;
                    previewItem.addEventListener('click', () => this.showPanorama(item.panorama.originalIndex));
                    
                    previewItem.innerHTML = `
                        <img class="preview-img" src="${item.panorama.url}" alt="${item.panorama.name}">
                        <div class="preview-info">
                            <div class="preview-name">ÁÇπ‰Ωç: ${item.pointId}</div>
                            <div class="preview-points">${item.panorama.name}<br>ÊãçÊëÑÊó•Êúü: ${item.panorama.date}</div>
                        </div>
                    `;
                    
                    previewContainer.appendChild(previewItem);
                });
                
                document.getElementById('preview-section-title').innerHTML = 
                    `Ê•ºÂ±Ç <span id="preview-floor-display">${this.currentFloor}</span> ÂÖ®ÊôØÂõæÈ¢ÑËßà (<span id="panorama-count">${pointLatestPanoramas.length}</span>Âº†)`;
            }
            
            showPanorama(index, pointId = null) {
                if (index < 0 || index >= this.panoramas.length) return;
                
                this.currentPanoramaIndex = index;
                this.currentPointId = pointId;
                this.showFullscreenPanorama(this.panoramas[index].url, this.panoramas[index].name, pointId);
            }
            
            showPanoramaByPointId(pointId) {
                if (this.pointPanoramaMap.has(pointId)) {
                    const panoramaIndices = this.pointPanoramaMap.get(pointId);
                    
                    if (panoramaIndices.length > 0) {
                        // ÊåâÊó•ÊúüÊéíÂ∫èÔºåÊòæÁ§∫ÊúÄÊñ∞ÁöÑ
                        const sortedPanoramas = panoramaIndices
                            .map(index => ({ ...this.panoramas[index], originalIndex: index }))
                            .sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        this.showPanorama(sortedPanoramas[0].originalIndex, pointId);
                    } else {
                        alert(`ÁÇπ‰Ωç ${pointId} Êú™ÂÖ≥ËÅî‰ªª‰ΩïÂÖ®ÊôØÂõæ`);
                    }
                } else {
                    alert(`ÁÇπ‰Ωç ${pointId} Êú™ÂÖ≥ËÅî‰ªª‰ΩïÂÖ®ÊôØÂõæ`);
                }
            }
            
            showFullscreenPanorama(panoramaUrl, panoramaName, pointId = null) {
                document.getElementById('panorama-fullscreen').style.display = 'flex';
                document.getElementById('panorama-title').textContent = panoramaName;
                
                this.setupThreeJSForFullscreen(panoramaUrl);
                this.updatePanoramaList(pointId);
                document.body.style.overflow = 'hidden';
            }
            
            updatePanoramaList(pointId) {
                const panoramaListElement = document.getElementById('panorama-list');
                panoramaListElement.innerHTML = '';
                
                if (!pointId || !this.pointPanoramaMap.has(pointId)) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'panorama-list-item';
                    emptyItem.style.textAlign = 'center';
                    emptyItem.style.padding = '20px';
                    emptyItem.textContent = 'ËØ•ÁÇπ‰ΩçÊú™ÂÖ≥ËÅîÂÖ®ÊôØÂõæ';
                    panoramaListElement.appendChild(emptyItem);
                    return;
                }
                
                const panoramaIndices = this.pointPanoramaMap.get(pointId);
                if (panoramaIndices.length === 0) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'panorama-list-item';
                    emptyItem.style.textAlign = 'center';
                    emptyItem.style.padding = '20px';
                    emptyItem.textContent = 'ËØ•ÁÇπ‰ΩçÊú™ÂÖ≥ËÅîÂÖ®ÊôØÂõæ';
                    panoramaListElement.appendChild(emptyItem);
                    return;
                }
                
                const sortedPanoramas = panoramaIndices
                    .map(index => ({ ...this.panoramas[index], originalIndex: index }))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedPanoramas.forEach((panorama, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = `panorama-list-item ${panorama.originalIndex === this.currentPanoramaIndex ? 'active' : ''}`;
                    listItem.innerHTML = `
                        <div class="panorama-list-name">${panorama.name}</div>
                        <div class="panorama-list-date">${panorama.date}</div>
                    `;
                    
                    listItem.addEventListener('click', () => {
                        this.showPanorama(panorama.originalIndex, pointId);
                    });
                    
                    panoramaListElement.appendChild(listItem);
                });
            }
            
            hideFullscreenPanorama() {
                document.getElementById('panorama-fullscreen').style.display = 'none';
                
                if (this.renderer) {
                    this.renderer.dispose();
                    this.renderer = null;
                }
                
                document.body.style.overflow = '';
                this.currentPointId = null;
            }
            
            showPreviousPanorama() {
                if (this.panoramas.length > 0) {
                    let newIndex = this.currentPanoramaIndex - 1;
                    if (newIndex < 0) newIndex = this.panoramas.length - 1;
                    this.showPanorama(newIndex, this.currentPointId);
                }
            }
            
            showNextPanorama() {
                if (this.panoramas.length > 0) {
                    let newIndex = this.currentPanoramaIndex + 1;
                    if (newIndex >= this.panoramas.length) newIndex = 0;
                    this.showPanorama(newIndex, this.currentPointId);
                }
            }
            
            setupThreeJSForFullscreen(panoramaUrl) {
                if (this.renderer) {
                    this.renderer.dispose();
                }
                
                this.scene = new THREE.Scene();
                
                this.camera = new THREE.PerspectiveCamera(75, (window.innerWidth - 300) / window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 0, 0.1);
                
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth - 300, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                
                const panoramaCanvas = document.getElementById('panorama-canvas');
                panoramaCanvas.innerHTML = '';
                panoramaCanvas.appendChild(this.renderer.domElement);
                
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                
                const textureLoader = new THREE.TextureLoader();
                textureLoader.load(panoramaUrl, (texture) => {
                    this.createPanoramaSphere(texture);
                });
                
                this.animate();
            }
            
            createPanoramaSphere(texture) {
                if (this.sphere) {
                    this.scene.remove(this.sphere);
                }
                
                const geometry = new THREE.SphereGeometry(500, 60, 40);
                geometry.scale(-1, 1, 1);
                
                const material = new THREE.MeshBasicMaterial({
                    map: texture
                });
                
                this.sphere = new THREE.Mesh(geometry, material);
                this.scene.add(this.sphere);
            }
            
            animate() {
                if (!this.renderer) return;
                
                requestAnimationFrame(() => this.animate());
                
                if (this.controls) {
                    this.controls.update();
                }
                
                this.renderer.render(this.scene, this.camera);
            }
            
            // ÊòæÁ§∫ÁÇπ‰ΩçÂÖ≥ËÅîÊ∏ÖÂçï
            showPointAssociationList() {
                document.getElementById('point-association-modal').style.display = 'flex';
                document.getElementById('modal-floor-display').textContent = this.currentFloor;
                this.updatePointAssociationList();
            }
            
            // Êõ¥Êñ∞ÁÇπ‰ΩçÂÖ≥ËÅîÊ∏ÖÂçï
            updatePointAssociationList() {
                const pointListElement = document.getElementById('point-list');
                pointListElement.innerHTML = '';
                
                // Ëé∑ÂèñÂΩìÂâçÊ•ºÂ±ÇÁöÑÊâÄÊúâÁÇπ‰Ωç
                const currentFloorPoints = this.floorPoints.filter(point => point.floor === this.currentFloor);
                
                if (currentFloorPoints.length === 0) {
                    pointListElement.innerHTML = '<div class="empty-message">ÂΩìÂâçÊ•ºÂ±ÇÊ≤°ÊúâÁÇπ‰Ωç</div>';
                    this.updatePanoramaListForModal(null);
                    return;
                }
                
                // ÊåâÁÇπ‰ΩçIDÊéíÂ∫è
                currentFloorPoints.sort((a, b) => {
                    const aNum = parseInt(a.id.split('F-')[1]);
                    const bNum = parseInt(b.id.split('F-')[1]);
                    return aNum - bNum;
                });
                
                currentFloorPoints.forEach((point) => {
                    const pointItem = document.createElement('div');
                    pointItem.className = 'point-list-item';
                    pointItem.dataset.pointId = point.id;
                    
                    const panoramaCount = this.pointPanoramaMap.has(point.id) ? this.pointPanoramaMap.get(point.id).length : 0;
                    
                    pointItem.innerHTML = `
                        <div class="point-list-name">${point.id}</div>
                        <div class="point-list-count">ÂÖ≥ËÅîÂÖ®ÊôØÂõæ: ${panoramaCount}Âº†</div>
                    `;
                    
                    pointItem.addEventListener('click', () => {
                        // ÁßªÈô§ÊâÄÊúâÊøÄÊ¥ªÁä∂ÊÄÅ
                        document.querySelectorAll('.point-list-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // Ê∑ªÂä†ÂΩìÂâçÊøÄÊ¥ªÁä∂ÊÄÅ
                        pointItem.classList.add('active');
                        
                        // Êõ¥Êñ∞ÂÖ®ÊôØÂõæÂàóË°®
                        this.updatePanoramaListForModal(point.id);
                    });
                    
                    pointListElement.appendChild(pointItem);
                });
                
                // ÈªòËÆ§ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÁÇπ‰Ωç
                const firstPointItem = pointListElement.querySelector('.point-list-item');
                if (firstPointItem) {
                    firstPointItem.classList.add('active');
                    const pointId = firstPointItem.dataset.pointId;
                    this.updatePanoramaListForModal(pointId);
                }
            }
            
            // Êõ¥Êñ∞ÁÇπ‰ΩçÂÖ≥ËÅîÁöÑÂÖ®ÊôØÂõæÂàóË°®ÔºàÂú®Ê®°ÊÄÅÊ°Ü‰∏≠Ôºâ
            updatePanoramaListForModal(pointId) {
                const panoramaListModal = document.getElementById('panorama-list-modal');
                const selectedPointName = document.getElementById('selected-point-name');
                
                if (!pointId) {
                    selectedPointName.textContent = 'Êú™ÈÄâÊã©';
                    panoramaListModal.innerHTML = '<div class="empty-message">ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™ÁÇπ‰ΩçÊü•ÁúãÂÖ∂ÂÖ≥ËÅîÁöÑÂÖ®ÊôØÂõæ</div>';
                    return;
                }
                
                selectedPointName.textContent = pointId;
                
                if (!this.pointPanoramaMap.has(pointId)) {
                    panoramaListModal.innerHTML = '<div class="empty-message">ËØ•ÁÇπ‰ΩçÊ≤°ÊúâÂÖ≥ËÅîÁöÑÂÖ®ÊôØÂõæ</div>';
                    return;
                }
                
                const panoramaIndices = this.pointPanoramaMap.get(pointId);
                
                if (panoramaIndices.length === 0) {
                    panoramaListModal.innerHTML = '<div class="empty-message">ËØ•ÁÇπ‰ΩçÊ≤°ÊúâÂÖ≥ËÅîÁöÑÂÖ®ÊôØÂõæ</div>';
                    return;
                }
                
                // ÊåâÊó•Êúü‰ªéËøëÂà∞ËøúÊéíÂ∫è
                const sortedPanoramas = panoramaIndices
                    .map(index => ({ ...this.panoramas[index], originalIndex: index }))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                panoramaListModal.innerHTML = '';
                
                sortedPanoramas.forEach((panorama) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'panorama-list-item-modal';
                    listItem.dataset.panoramaIndex = panorama.originalIndex;
                    
                    listItem.innerHTML = `
                        <div class="panorama-list-info">
                            <div class="panorama-list-name-modal">${panorama.name}</div>
                            <div class="panorama-list-date-modal">ÊãçÊëÑÊó•Êúü: ${panorama.date}</div>
                        </div>
                        <button class="panorama-delete-btn" data-panorama-index="${panorama.originalIndex}" data-point-id="${pointId}">Âà†Èô§</button>
                    `;
                    
                    // Ê∑ªÂä†Âà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
                    const deleteBtn = listItem.querySelector('.panorama-delete-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Èò≤Ê≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                        const panoramaIndex = parseInt(e.target.dataset.panoramaIndex);
                        const pointId = e.target.dataset.pointId;
                        this.deletePanoramaFromPoint(panoramaIndex, pointId);
                    });
                    
                    panoramaListModal.appendChild(listItem);
                });
            }
            
            // ‰ªéÁÇπ‰Ωç‰∏≠Âà†Èô§ÂÖ®ÊôØÂõæ
            deletePanoramaFromPoint(panoramaIndex, pointId) {
                const panorama = this.panoramas[panoramaIndex];
                
                if (!confirm(`Á°ÆÂÆöË¶Å‰ªéÁÇπ‰Ωç ${pointId} ‰∏≠Âà†Èô§ÂÖ®ÊôØÂõæ "${panorama.name}" ÂêóÔºü`)) {
                    return;
                }
                
                if (this.pointPanoramaMap.has(pointId)) {
                    const panoramaIndices = this.pointPanoramaMap.get(pointId);
                    
                    // ‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§ËØ•ÂÖ®ÊôØÂõæÁ¥¢Âºï
                    const updatedIndices = panoramaIndices.filter(index => index !== panoramaIndex);
                    
                    if (updatedIndices.length === 0) {
                        // Â¶ÇÊûúÊ≤°ÊúâÂÖ≥ËÅîÁöÑÂÖ®ÊôØÂõæ‰∫ÜÔºåÂà†Èô§Êï¥‰∏™ÈîÆ
                        this.pointPanoramaMap.delete(pointId);
                    } else {
                        // Êõ¥Êñ∞ÂÖ≥ËÅî
                        this.pointPanoramaMap.set(pointId, updatedIndices);
                    }
                    
                    // Êõ¥Êñ∞ÊòæÁ§∫
                    this.updatePanoramaListForModal(pointId);
                    this.updatePointAssociationList();
                    this.updatePreviewItems();
                    this.renderFloorPlan();
                    this.saveAllData();
                    
                    alert(`Â∑≤‰ªéÁÇπ‰Ωç ${pointId} ‰∏≠Âà†Èô§ÂÖ®ÊôØÂõæ "${panorama.name}"`);
                }
            }
            
            exportData() {
                try {
                    const floorPlansData = {};
                    for (const floor in this.floorImages) {
                        if (this.floorImages[floor]) {
                            floorPlansData[floor] = this.floorImages[floor].src;
                        }
                    }
                    
                    const data = {
                        floorPlans: floorPlansData,
                        points: this.floorPoints,
                        panoramas: this.panoramas,
                        associations: Array.from(this.pointPanoramaMap.entries()),
                        settings: {
                            pointRadius: this.pointRadius,
                            pointFontSize: this.pointFontSize
                        }
                    };
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const date = new Date();
                    const dateStr = `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}_${date.getHours()}-${date.getMinutes()}`;
                    const filename = `ÂÖ®ÊôØÂõæÁ≥ªÁªüÊï∞ÊçÆ_${dateStr}.json`;
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = filename;
                    link.click();
                    
                    alert(`Êï∞ÊçÆÂ∑≤ÂØºÂá∫Âà∞Êñá‰ª∂: ${filename}`);
                } catch (error) {
                    console.error('ÂØºÂá∫Â§±Ë¥•:', error);
                    alert('Êï∞ÊçÆÂØºÂá∫Â§±Ë¥•: ' + error.message);
                }
            }
            
            importData(file) {
                if (!file || file.type !== 'application/json') {
                    alert('ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑJSONÊñá‰ª∂');
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (!data.floorPlans || !data.points || !data.panoramas || !data.associations) {
                            throw new Error('Êï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ');
                        }
                        
                        this.floorImages = {};
                        for (const floor in data.floorPlans) {
                            this.floorImages[floor] = new Image();
                            this.floorImages[floor].src = data.floorPlans[floor];
                        }
                        
                        this.floorPoints = data.points;
                        this.panoramas = data.panoramas;
                        this.pointPanoramaMap = new Map(data.associations);
                        
                        // ‰øùÊåÅÂõ∫ÂÆöÂÄº
                        this.pointRadius = 32;
                        this.pointFontSize = 30;
                        
                        this.updateCurrentFloorDisplay();
                        this.renderFloorPlan();
                        this.updatePreviewItems();
                        this.saveAllData();
                        
                        alert('Êï∞ÊçÆÂØºÂÖ•ÊàêÂäüÔºÅ');
                    } catch (error) {
                        console.error('ÂØºÂÖ•Â§±Ë¥•:', error);
                        alert('Êï∞ÊçÆÂØºÂÖ•Â§±Ë¥•: ' + error.message);
                    }
                };
                
                reader.onerror = () => {
                    alert('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•');
                };
                
                reader.readAsText(file);
            }
            
            clearAllData() {
                this.floorImages = {};
                this.floorPoints = [];
                this.pointPanoramaMap.clear();
                this.panoramas = [];
                this.selectedPoint = null;
                this.currentPanoramaIndex = 0;
                this.currentPointId = null;
                
                for (const key in this.STORAGE_KEYS) {
                    localStorage.removeItem(this.STORAGE_KEYS[key]);
                }
                
                this.createExampleFloorPlans();
                this.renderFloorPlan();
                this.updatePreviewItems();
                
                alert('ÊâÄÊúâÊï∞ÊçÆÂ∑≤Ê∏ÖÈô§ÔºåÂ∑≤ÊÅ¢Â§ç‰∏∫ÈªòËÆ§Áä∂ÊÄÅ');
            }
            
            saveAllData() {
                try {
                    const floorPlansData = {};
                    for (const floor in this.floorImages) {
                        if (this.floorImages[floor]) {
                            floorPlansData[floor] = this.floorImages[floor].src;
                        }
                    }
                    localStorage.setItem(this.STORAGE_KEYS.FLOOR_PLANS, JSON.stringify(floorPlansData));
                    
                    localStorage.setItem(this.STORAGE_KEYS.POINTS, JSON.stringify(this.floorPoints));
                    
                    const panoramaData = this.panoramas.map(p => ({
                        name: p.name,
                        url: p.url,
                        date: p.date
                    }));
                    localStorage.setItem(this.STORAGE_KEYS.PANORAMAS, JSON.stringify(panoramaData));
                    
                    const associations = Array.from(this.pointPanoramaMap.entries());
                    localStorage.setItem(this.STORAGE_KEYS.ASSOCIATIONS, JSON.stringify(associations));
                    
                    // ‰∏çÂÜç‰øùÂ≠òÁÇπÂçäÂæÑÂíåÂ≠ó‰ΩìÂ§ßÂ∞èÔºåÂõ†‰∏∫ÂÆÉ‰ª¨ÊòØÂõ∫ÂÆöÁöÑ
                } catch (error) {
                    console.error('‰øùÂ≠òÂ§±Ë¥•:', error);
                }
            }
            
            loadAllData() {
                try {
                    const floorPlansData = JSON.parse(localStorage.getItem(this.STORAGE_KEYS.FLOOR_PLANS));
                    if (floorPlansData) {
                        for (const floor in floorPlansData) {
                            if (floorPlansData[floor]) {
                                this.floorImages[floor] = new Image();
                                this.floorImages[floor].src = floorPlansData[floor];
                            }
                        }
                    }
                    
                    const pointsData = JSON.parse(localStorage.getItem(this.STORAGE_KEYS.POINTS));
                    if (pointsData) {
                        this.floorPoints = pointsData;
                    }
                    
                    const panoramaData = JSON.parse(localStorage.getItem(this.STORAGE_KEYS.PANORAMAS));
                    if (panoramaData) {
                        this.panoramas = panoramaData;
                    }
                    
                    const associationsData = JSON.parse(localStorage.getItem(this.STORAGE_KEYS.ASSOCIATIONS));
                    if (associationsData) {
                        this.pointPanoramaMap = new Map(associationsData);
                    }
                    
                    // ‰øùÊåÅÂõ∫ÂÆöÂÄº
                    this.pointRadius = 32;
                    this.pointFontSize = 30;
                    
                    this.renderFloorPlan();
                    this.updatePreviewItems();
                } catch (error) {
                    console.error('Âä†ËΩΩÂ§±Ë¥•:', error);
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            new PanoramaManagementSystem();
        });
    </script>
</body>
</html>