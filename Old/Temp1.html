<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∫∑‰∏öÂÖ®ÊôØÂõæÁÆ°ÁêÜÁ≥ªÁªü</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        /* Ê†∑ÂºèÂÆåÂÖ®‰øùÁïôÂπ∂Êñ∞Â¢ûÂè†Âä†Ê†∑Âºè */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }

        header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .floor-plan-section {
            flex: 2;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .preview-section {
            flex: 1;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 1.2rem;
            color: #fdbb2d;
            font-weight: bold;
        }

        .section-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .control-btn.active {
            background: #fdbb2d;
            color: #1a2a6c;
            font-weight: bold;
        }

        .floor-content {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        .floor-canvas-container {
            flex: 3;
            position: relative;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        #floor-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            display: block;
        }

        .floor-controls-panel {
            flex: 1;
            max-width: 300px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
            color: #fdbb2d;
        }

        .browse-btn {
            background: #fdbb2d;
            color: #1a2a6c;
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }

        .control-group {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
        }

        .control-group-title {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: #fdbb2d;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 5px;
        }

        .floor-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .preview-container {
            flex: 1;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 15px;
            align-items: center;
        }

        .preview-item {
            min-width: 200px;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            flex-shrink: 0;
        }

        .preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
        }

        .preview-name {
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .panorama-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: row;
        }

        .panorama-list-container {
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panorama-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .panorama-list-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .panorama-list-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fdbb2d;
        }

        .panorama-viewer-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .panorama-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10;
        }

        .panorama-close {
            background: #ff4444;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .panorama-viewer {
            flex: 1;
            position: relative;
            background: #000;
            overflow: hidden;
        }

        /* ÊëÑÂÉèÂ§¥ÂõæÂ±ÇÊ†∑Âºè */
        #live-camera-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1; /* Âú®Â∫ïÈÉ® */
        }

        /* ÂÖ®ÊôØÂõæÂõæÂ±ÇÊ†∑Âºè */
        #panorama-canvas-box {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2; /* Âú®ÊëÑÂÉèÂ§¥‰∏äÊñπ */
        }

        .panorama-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10;
            flex-wrap: wrap;
        }

        .opacity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 5px 15px;
            border-radius: 25px;
        }

        .panorama-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .panorama-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .panorama-btn.camera-active {
            background: #4CAF50;
        }

        .save-load-buttons {
            display: flex;
            gap: 8px;
        }

        .data-operation-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            flex: 1;
            text-align: center;
        }

        .data-operation-btn.export {
            background: #9C27B0;
        }

        .data-operation-btn.import {
            background: #FF9800;
        }

        .point-association-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .point-association-content {
            background: #2a2a2a;
            width: 90%;
            max-width: 800px;
            height: 80%;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .point-association-header {
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .point-association-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .point-list-container {
            width: 300px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            padding: 10px;
        }

        .panorama-list-container-modal {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .panorama-list-item-modal {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panorama-delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Â∫∑‰∏öÂÖ®ÊôØÂõæÁÆ°ÁêÜÁ≥ªÁªü</h1>
        </header>
        <div class="main-content">
            <section class="floor-plan-section">
                <div class="section-header">
                    <div class="section-title">Âπ≥Èù¢ÂõæÊ†áÊ≥® - ÂΩìÂâçÊ•ºÂ±Ç: <span id="current-floor-display">1</span></div>
                    <div class="section-controls">
                        <button class="control-btn" id="view-point-btn">Êü•ÁúãÁÇπ‰Ωç</button>
                        <button class="control-btn" id="add-point-btn">Ê∑ªÂä†ÁÇπ‰Ωç</button>
                        <button class="control-btn" id="associate-btn">ÂÖ≥ËÅîÂÖ®ÊôØÂõæ</button>
                        <button class="control-btn" id="clear-points-btn">Ê∏ÖÈô§ÁÇπ‰Ωç</button>
                        <button class="control-btn" id="modify-point-btn">‰øÆÊîπÁÇπ‰ΩçÁºñÂè∑</button>
                        <button class="control-btn" id="zoom-in-btn">ÊîæÂ§ß</button>
                        <button class="control-btn" id="zoom-out-btn">Áº©Â∞è</button>
                        <button class="control-btn" id="reset-view-btn">ÈáçÁΩÆËßÜÂõæ</button>
                        <button class="control-btn" id="point-association-list-btn">ÁÇπ‰ΩçÂÖ≥ËÅîÊ∏ÖÂçï</button>
                    </div>
                </div>
                <div class="floor-content">
                    <div class="floor-canvas-container">
                        <canvas id="floor-canvas"></canvas>
                    </div>
                    <div class="floor-controls-panel">
                        <div class="upload-area">
                            <div class="upload-icon">üè¢</div>
                            <button class="browse-btn" id="browse-floor-btn">‰∏ä‰º†Âπ≥Èù¢Âõæ</button>
                        </div>
                        <div class="control-group">
                            <div class="control-group-title">Ê•ºÂ±ÇÂàáÊç¢</div>
                            <div class="floor-buttons" id="floor-buttons-container">
                                <button class="control-btn" id="add-floor-btn">Ê∑ªÂä†Ê•ºÂ±Ç</button>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="control-group-title">Êï∞ÊçÆÊñá‰ª∂Êìç‰Ωú</div>
                            <div class="save-load-buttons">
                                <button class="data-operation-btn export" id="export-data-btn">ÂØºÂá∫Êñá‰ª∂</button>
                                <button class="data-operation-btn import" id="import-data-btn">ÂØºÂÖ•Êñá‰ª∂</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section class="preview-section">
                <div class="section-header">
                    <div class="section-title">Ê•ºÂ±Ç <span id="preview-floor-display">1</span> È¢ÑËßà (<span
                            id="panorama-count">0</span>Âº†)</div>
                    <div class="section-controls">
                        <button class="control-btn" id="clear-all-data-btn" style="background:#ff4444;">Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ</button>
                    </div>
                </div>
                <div class="preview-container" id="preview-container"></div>
            </section>
        </div>
    </div>

    <div class="panorama-fullscreen" id="panorama-fullscreen">
        <div class="panorama-list-container">
            <div class="panorama-list" id="panorama-list"></div>
        </div>
        <div class="panorama-viewer-container">
            <div class="panorama-header">
                <div id="panorama-title">ÂÖ®ÊôØÊü•ÁúãÂô®</div>
                <button class="panorama-close" id="panorama-close">√ó</button>
            </div>
            <div class="panorama-viewer">
                <video id="live-camera-video" autoplay playsinline></video>
                <div id="panorama-canvas-box"></div>
            </div>
            <div class="panorama-controls">
                <button class="panorama-btn" id="prev-panorama-btn">‚óÄ</button>
                <button class="panorama-btn" id="reset-panorama-view-btn">‚Ü∫</button>
                <button class="panorama-btn" id="next-panorama-btn">‚ñ∂</button>
                
                <div class="opacity-control">
                    <span>ÂÖ®ÊôØÈÄèÊòéÂ∫¶:</span>
                    <input type="range" id="panorama-opacity-slider" min="0" max="100" value="100">
                    <span id="opacity-value">100%</span>
                </div>

                <button class="panorama-btn" id="toggle-camera-btn" title="ÂºÄÂêØÂÆûÊó∂ÊëÑÂÉèÂ§¥">üì∑</button>
            </div>
        </div>
    </div>

    <div class="point-association-modal" id="point-association-modal">
        <div class="point-association-content">
            <div class="point-association-header">
                <div>ÁÇπ‰ΩçÁÆ°ÁêÜ - Ê•ºÂ±Ç: <span id="modal-floor-display">1</span></div>
                <button class="panorama-close" id="point-association-close">√ó</button>
            </div>
            <div class="point-association-body">
                <div class="point-list-container" id="point-list"></div>
                <div class="panorama-list-container-modal" id="panorama-list-modal"></div>
            </div>
        </div>
    </div>

    <input type="file" id="file-input-floor" accept="image/*" style="display: none;">
    <input type="file" id="file-input-panorama" accept="image/*" multiple style="display: none;">
    <input type="file" id="file-import-data" accept=".json" style="display: none;">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>

    <script>
        class IndexedDBHelper {
            constructor() { this.dbName = 'PanoramaSystemDB'; this.dbVersion = 1; this.storeName = 'appData'; this.db = null; }
            init() {
                return new Promise((resolve) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                    request.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains(this.storeName)) db.createObjectStore(this.storeName); };
                });
            }
            setItem(key, value) {
                return new Promise((resolve) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    transaction.objectStore(this.storeName).put(value, key);
                    transaction.oncomplete = () => resolve();
                });
            }
            getItem(key) {
                return new Promise((resolve) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const request = transaction.objectStore(this.storeName).get(key);
                    request.onsuccess = () => resolve(request.result);
                });
            }
            clear() {
                return new Promise((resolve) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    transaction.objectStore(this.storeName).clear();
                    transaction.oncomplete = () => resolve();
                });
            }
        }

        class PanoramaManagementSystem {
            constructor() {
                this.idb = new IndexedDBHelper();
                this.initVariables();
                this.idb.init().then(() => {
                    this.setupEventListeners();
                    this.loadAllData();
                });
            }

            initVariables() {
                this.floorCanvas = document.getElementById('floor-canvas');
                this.floorCtx = this.floorCanvas.getContext('2d');
                this.floorImages = {};
                this.floorPoints = [];
                this.currentFloor = '1';
                this.pointPanoramaMap = new Map();
                this.panoramas = [];
                this.mode = 'normal';
                this.scale = 1.0; this.offsetX = 0; this.offsetY = 0;
                this.pointRadius = 32;
                this.pointFontSize = 30;
                this.STORAGE_KEYS = { FLOOR_PLANS: 'floorPlans', POINTS: 'points', PANORAMAS: 'panos', ASSOCIATIONS: 'assocs' };
                
                // ÊëÑÂÉèÂ§¥ÊµÅÂØπË±°
                this.cameraStream = null;
            }

            updateFloorButtonsUI() {
                const container = document.getElementById('floor-buttons-container');
                const addBtn = document.getElementById('add-floor-btn');
                container.innerHTML = '';
                const floors = Object.keys(this.floorImages).sort((a, b) => parseInt(a) - parseInt(b));
                floors.forEach(floor => {
                    const btn = document.createElement('button');
                    btn.className = `control-btn floor-btn ${this.currentFloor === floor ? 'active' : ''}`;
                    btn.textContent = floor;
                    btn.onclick = () => this.switchFloor(floor);
                    container.appendChild(btn);
                });
                container.appendChild(addBtn);
            }

            switchFloor(floor) {
                this.currentFloor = floor;
                this.updateFloorButtonsUI();
                document.getElementById('current-floor-display').textContent = floor;
                document.getElementById('preview-floor-display').textContent = floor;
                this.autoAdjustImage(); this.renderFloorPlan(); this.updatePreviewItems();
            }

            setupEventListeners() {
                document.getElementById('browse-floor-btn').onclick = () => document.getElementById('file-input-floor').click();
                document.getElementById('file-input-floor').onchange = (e) => { if (e.target.files[0]) this.loadFloorPlan(e.target.files[0]); };
                document.getElementById('add-floor-btn').onclick = () => {
                    const floors = Object.keys(this.floorImages).map(f => parseInt(f));
                    const nextFloor = (floors.length > 0 ? Math.max(...floors) + 1 : 1).toString();
                    this.createDefaultFloorPlan(nextFloor);
                    this.updateFloorButtonsUI();
                    this.switchFloor(nextFloor);
                };
                document.getElementById('export-data-btn').onclick = () => this.exportData();
                document.getElementById('import-data-btn').onclick = () => document.getElementById('file-import-data').click();
                document.getElementById('file-import-data').onchange = (e) => { if (e.target.files[0]) this.importData(e.target.files[0]); };
                
                document.getElementById('view-point-btn').onclick = () => this.setMode('view');
                document.getElementById('add-point-btn').onclick = () => this.setMode('add');
                document.getElementById('associate-btn').onclick = () => this.setMode('associate');
                document.getElementById('clear-points-btn').onclick = () => this.setMode('delete');
                document.getElementById('modify-point-btn').onclick = () => this.setMode('modify');
                document.getElementById('zoom-in-btn').onclick = () => { this.scale *= 1.1; this.renderFloorPlan(); };
                document.getElementById('zoom-out-btn').onclick = () => { this.scale /= 1.1; this.renderFloorPlan(); };
                document.getElementById('reset-view-btn').onclick = () => { this.autoAdjustImage(); this.renderFloorPlan(); };
                document.getElementById('clear-all-data-btn').onclick = () => { if (confirm('Á°ÆÂÆöÊ∏ÖÁ©∫ÂêóÔºü')) this.clearAllData(); };
                this.floorCanvas.onclick = (e) => this.handleCanvasClick(e);
                window.onresize = () => this.adjustCanvasSize();
                this.adjustCanvasSize();
                
                // ÂÖ≥Èó≠ÂÖ®Â±èÂÖ®ÊôØÊó∂ÂÅúÊ≠¢ÊëÑÂÉèÂ§¥
                document.getElementById('panorama-close').onclick = () => {
                    document.getElementById('panorama-fullscreen').style.display = 'none';
                    this.stopCamera();
                };
                
                document.getElementById('point-association-close').onclick = () => document.getElementById('point-association-modal').style.display = 'none';
                document.getElementById('point-association-list-btn').onclick = () => { document.getElementById('point-association-modal').style.display = 'flex'; this.renderModalPoints(); };

                // Êñ∞Â¢ûÔºöÈÄèÊòéÂ∫¶ÊªëÂùóÁõëÂê¨
                const opacitySlider = document.getElementById('panorama-opacity-slider');
                const opacityDisplay = document.getElementById('opacity-value');
                const panoBox = document.getElementById('panorama-canvas-box');
                opacitySlider.oninput = (e) => {
                    const val = e.target.value;
                    opacityDisplay.textContent = val + '%';
                    panoBox.style.opacity = val / 100;
                };

                // Êñ∞Â¢ûÔºöÊëÑÂÉèÂ§¥ÂºÄÂÖ≥ÂàáÊç¢
                document.getElementById('toggle-camera-btn').onclick = () => this.toggleCamera();
            }

            // ÊëÑÂÉèÂ§¥ÈÄªËæë
            async toggleCamera() {
                const btn = document.getElementById('toggle-camera-btn');
                const video = document.getElementById('live-camera-video');
                
                if (this.cameraStream) {
                    this.stopCamera();
                    btn.classList.remove('camera-active');
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { facingMode: "environment" }, // ‰ºòÂÖà‰ΩøÁî®ÂêéÁΩÆÊëÑÂÉèÂ§¥
                            audio: false 
                        });
                        this.cameraStream = stream;
                        video.srcObject = stream;
                        btn.classList.add('camera-active');
                    } catch (err) {
                        alert("Êó†Ê≥ïËÆøÈóÆÊëÑÂÉèÂ§¥: " + err.message);
                    }
                }
            }

            stopCamera() {
                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(track => track.stop());
                    this.cameraStream = null;
                    document.getElementById('live-camera-video').srcObject = null;
                    document.getElementById('toggle-camera-btn').classList.remove('camera-active');
                }
            }

            setMode(mode) {
                this.mode = mode;
                document.querySelectorAll('.section-controls .control-btn').forEach(b => b.classList.remove('active'));
                const btnIds = { 
                    'view': 'view-point-btn',
                    'add': 'add-point-btn', 
                    'associate': 'associate-btn', 
                    'delete': 'clear-points-btn', 
                    'modify': 'modify-point-btn' 
                };
                if (btnIds[mode]) document.getElementById(btnIds[mode]).classList.add('active');
            }

            async saveAllData() {
                const floorData = {}; for (let f in this.floorImages) floorData[f] = this.floorImages[f].src;
                await this.idb.setItem(this.STORAGE_KEYS.FLOOR_PLANS, floorData);
                await this.idb.setItem(this.STORAGE_KEYS.POINTS, this.floorPoints);
                await this.idb.setItem(this.STORAGE_KEYS.PANORAMAS, this.panoramas);
                await this.idb.setItem(this.STORAGE_KEYS.ASSOCIATIONS, Array.from(this.pointPanoramaMap.entries()));
            }

            async loadAllData() {
                const floorData = await this.idb.getItem(this.STORAGE_KEYS.FLOOR_PLANS);
                if (floorData) { this.floorImages = {}; for (let f in floorData) { const img = new Image(); img.src = floorData[f]; this.floorImages[f] = img; } }
                else { this.createDefaultFloorPlan('1'); }
                this.floorPoints = await this.idb.getItem(this.STORAGE_KEYS.POINTS) || [];
                this.panoramas = await this.idb.getItem(this.STORAGE_KEYS.PANORAMAS) || [];
                const assocs = await this.idb.getItem(this.STORAGE_KEYS.ASSOCIATIONS);
                this.pointPanoramaMap = assocs ? new Map(assocs) : new Map();
                this.updateFloorButtonsUI(); this.switchFloor(this.currentFloor);
            }

            exportData() {
                const now = new Date();
                const timestamp = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
                const fileName = `${timestamp}_${Object.keys(this.floorImages).length}Â±Ç_${this.panoramas.length}Âº†.json`;
                const floorData = {}; for (let f in this.floorImages) floorData[f] = this.floorImages[f].src;
                const data = { floorPlans: floorData, points: this.floorPoints, panoramas: this.panoramas, associations: Array.from(this.pointPanoramaMap.entries()) };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fileName; a.click();
            }

            importData(file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const data = JSON.parse(e.target.result);
                    this.floorImages = {};
                    for (let f in data.floorPlans) { const img = new Image(); img.src = data.floorPlans[f]; this.floorImages[f] = img; }
                    this.floorPoints = data.points; this.panoramas = data.panoramas; this.pointPanoramaMap = new Map(data.associations);
                    this.updateFloorButtonsUI(); this.switchFloor(Object.keys(this.floorImages)[0] || '1');
                    await this.saveAllData(); alert('ÂØºÂÖ•ÊàêÂäü');
                };
                reader.readAsText(file);
            }

            createDefaultFloorPlan(floor) {
                const cvs = document.createElement('canvas');
                cvs.width = 800;
                cvs.height = 600;
                const ctx = cvs.getContext('2d');
                ctx.clearRect(0, 0, 800, 600);
                const img = new Image();
                img.src = cvs.toDataURL();
                this.floorImages[floor] = img;
            }

            loadFloorPlan(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => { this.floorImages[this.currentFloor] = img; this.autoAdjustImage(); this.renderFloorPlan(); this.saveAllData(); };
                };
                reader.readAsDataURL(file);
            }

            handleCanvasClick(e) {
                const rect = this.floorCanvas.getBoundingClientRect();
                const x = (e.clientX - rect.left - this.offsetX) / this.scale;
                const y = (e.clientY - rect.top - this.offsetY) / this.scale;
                const clickedPoint = this.floorPoints.find(p => p.floor === this.currentFloor && Math.hypot(p.x - x, p.y - y) < this.pointRadius / this.scale);
                
                if (this.mode === 'add') {
                    const id = `${this.currentFloor}F-${this.floorPoints.filter(p => p.floor === this.currentFloor).length + 1}`;
                    this.floorPoints.push({ id, x, y, floor: this.currentFloor });
                    this.renderFloorPlan(); this.saveAllData();
                } else if (this.mode === 'delete' && clickedPoint) {
                    this.floorPoints = this.floorPoints.filter(p => p !== clickedPoint);
                    this.renderFloorPlan(); this.saveAllData();
                } else if (this.mode === 'modify' && clickedPoint) {
                    const nid = prompt('‰øÆÊîπÁºñÂè∑:', clickedPoint.id); if (nid) { clickedPoint.id = nid; this.renderFloorPlan(); this.saveAllData(); }
                } else if (this.mode === 'associate' && clickedPoint) {
                    this.startAssociate(clickedPoint.id);
                } else if (this.mode === 'view' && clickedPoint) {
                    const idxs = this.pointPanoramaMap.get(clickedPoint.id);
                    if (idxs && idxs.length > 0) {
                        this.openPano(idxs[0], clickedPoint.id);
                    } else {
                        alert('ËØ•ÁÇπ‰ΩçÊöÇÊó†ÂÖ®ÊôØÂõæ');
                    }
                }
            }

            startAssociate(pointId) {
                const input = document.getElementById('file-input-panorama');
                input.onchange = (e) => {
                    const files = Array.from(e.target.files);
                    files.forEach(file => {
                        EXIF.getData(file, () => {
                            let timeStr;
                            const exifDate = EXIF.getTag(file, "DateTimeOriginal");
                            
                            if (exifDate) {
                                timeStr = exifDate.replace(/:/g, "").replace(" ", "_");
                            } else {
                                const now = new Date();
                                timeStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
                            }

                            const reader = new FileReader();
                            reader.onload = (re) => {
                                const img = new Image();
                                img.src = re.target.result;
                                img.onload = () => {
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    const maxWidth = 4096;
                                    let width = img.width;
                                    let height = img.height;

                                    if (width > maxWidth) {
                                        height = (maxWidth / width) * height;
                                        width = maxWidth;
                                    }

                                    canvas.width = width;
                                    canvas.height = height;
                                    ctx.drawImage(img, 0, 0, width, height);

                                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.4);
                                    
                                    const originalName = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
                                    const ext = file.name.substring(file.name.lastIndexOf('.'));
                                    const newName = `${originalName}_${timeStr}${ext}`;

                                    this.panoramas.push({ name: newName, url: compressedBase64 });
                                    const idx = this.panoramas.length - 1;
                                    if (!this.pointPanoramaMap.has(pointId)) this.pointPanoramaMap.set(pointId, []);
                                    this.pointPanoramaMap.get(pointId).push(idx);

                                    this.updatePreviewItems();
                                    this.renderFloorPlan();
                                    this.saveAllData();
                                };
                            };
                            reader.readAsDataURL(file);
                        });
                    });
                };
                input.click();
            }

            openPano(idx, pointId) {
                const pano = this.panoramas[idx];
                document.getElementById('panorama-fullscreen').style.display = 'flex';
                document.getElementById('panorama-title').textContent = pano.name;
                this.initThree(pano.url);
                const list = document.getElementById('panorama-list'); list.innerHTML = '';
                this.pointPanoramaMap.get(pointId).forEach(i => {
                    const item = document.createElement('div'); item.className = 'panorama-list-item' + (i === idx ? ' active' : '');
                    item.innerHTML = `<div>${this.panoramas[i].name}</div>`;
                    item.onclick = () => this.openPano(i, pointId); list.appendChild(item);
                });
            }

            initThree(url) {
                const container = document.getElementById('panorama-canvas-box'); container.innerHTML = '';
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ alpha: true }); // ÂÖÅËÆ∏Ê∏≤ÊüìÈÄèÊòéÂ∫¶
                renderer.setSize(container.clientWidth, container.clientHeight);
                container.appendChild(renderer.domElement);
                const g = new THREE.SphereGeometry(500, 60, 40); g.scale(-1, 1, 1);
                const t = new THREE.TextureLoader().load(url);
                scene.add(new THREE.Mesh(g, new THREE.MeshBasicMaterial({ map: t })));
                camera.position.set(0, 0, 0.1);
                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                const animate = () => { if (document.getElementById('panorama-fullscreen').style.display === 'none') return; requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); };
                animate();
            }

            renderFloorPlan() {
                const img = this.floorImages[this.currentFloor]; if (!img) return;
                this.floorCtx.clearRect(0, 0, this.floorCanvas.width, this.floorCanvas.height);
                this.floorCtx.save();
                this.floorCtx.translate(this.offsetX, this.offsetY);
                this.floorCtx.scale(this.scale, this.scale);
                this.floorCtx.drawImage(img, 0, 0);
                this.floorPoints.filter(p => p.floor === this.currentFloor).forEach(p => {
                    const hasPano = this.pointPanoramaMap.has(p.id) && this.pointPanoramaMap.get(p.id).length > 0;
                    this.floorCtx.fillStyle = hasPano ? '#4CAF50' : '#fdbb2d';
                    this.floorCtx.beginPath();
                    this.floorCtx.arc(p.x, p.y, this.pointRadius, 0, Math.PI * 2);
                    this.floorCtx.fill();
                    this.floorCtx.fillStyle = '#fff';
                    this.floorCtx.font = `bold ${this.pointFontSize}px Arial`;
                    this.floorCtx.textAlign = 'center'; this.floorCtx.textBaseline = 'middle';
                    this.floorCtx.fillText(p.id, p.x, p.y);
                });
                this.floorCtx.restore();
            }

            autoAdjustImage() {
                const img = this.floorImages[this.currentFloor]; if (!img) return;
                this.scale = Math.min(this.floorCanvas.width / img.width, this.floorCanvas.height / img.height) * 0.8;
                this.offsetX = (this.floorCanvas.width - img.width * this.scale) / 2;
                this.offsetY = (this.floorCanvas.height - img.height * this.scale) / 2;
            }

            updatePreviewItems() {
                const container = document.getElementById('preview-container'); container.innerHTML = ''; let count = 0;
                this.floorPoints.filter(p => p.floor === this.currentFloor).forEach(p => {
                    const idxs = this.pointPanoramaMap.get(p.id);
                    if (idxs) {
                        idxs.forEach(i => {
                            count++; const div = document.createElement('div'); div.className = 'preview-item';
                            div.innerHTML = `<img class="preview-img" src="${this.panoramas[i].url}"><div class="preview-info"><div class="preview-name">${p.id}-${this.panoramas[i].name}</div></div>`;
                            div.onclick = () => this.openPano(i, p.id); container.appendChild(div);
                        });
                    }
                });
                document.getElementById('panorama-count').textContent = count;
                if (!count) container.innerHTML = '<div style="width:100%;text-align:center;padding:40px;opacity:0.7;">ÊöÇÊó†ÂÖ®ÊôØÂõæ</div>';
            }

            adjustCanvasSize() { const p = this.floorCanvas.parentElement; this.floorCanvas.width = p.clientWidth; this.floorCanvas.height = p.clientHeight; this.autoAdjustImage(); this.renderFloorPlan(); }
            async clearAllData() { await this.idb.clear(); location.reload(); }
            renderModalPoints() {
                const list = document.getElementById('point-list'); list.innerHTML = '';
                this.floorPoints.filter(p => p.floor === this.currentFloor).forEach(p => {
                    const item = document.createElement('div'); item.className = 'panorama-list-item';
                    item.innerHTML = `<div>${p.id}</div>`;
                    item.onclick = () => { document.querySelectorAll('.panorama-list-item').forEach(el => el.classList.remove('active')); item.classList.add('active'); this.renderModalPanos(p.id); };
                    list.appendChild(item);
                });
            }
            renderModalPanos(pId) {
                const list = document.getElementById('panorama-list-modal'); list.innerHTML = '';
                const idxs = this.pointPanoramaMap.get(pId);
                if (idxs) {
                    idxs.forEach(idx => {
                        const item = document.createElement('div'); item.className = 'panorama-list-item-modal';
                        item.innerHTML = `<span>${this.panoramas[idx].name}</span><button class="panorama-delete-btn">Âà†Èô§</button>`;
                        item.querySelector('button').onclick = () => { this.pointPanoramaMap.set(pId, this.pointPanoramaMap.get(pId).filter(i => i !== idx)); this.renderModalPanos(pId); this.updatePreviewItems(); this.renderFloorPlan(); this.saveAllData(); };
                        list.appendChild(item);
                    });
                }
            }
        }
        document.addEventListener('DOMContentLoaded', () => new PanoramaManagementSystem());
    </script>
</body>

</html>